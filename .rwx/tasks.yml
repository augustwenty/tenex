on:
  github:
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
  cli:
    init:
      commit-sha: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: packages
    run: |
      sudo apt-get update
      sudo apt-get install -y postgresql-client
      sudo apt-get clean

  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/augustwenty/tenex.git
      ref: ${{ init.commit-sha }}

  - key: erlang
    call: erlang/install 1.1.1
    with:
      erlang-version: "26.2.2"

  - key: elixir
    use: erlang
    call: elixir-lang/install 1.1.2
    with:
      elixir-version: "1.17.2"

  - key: deps
    use: [code, packages, erlang, elixir]
    run: mix do deps.get, deps.compile
    filter:
      - mix.lock
      - mix.exs
    env:
      MIX_ENV: test

  - key: compile
    use: [packages, deps]
    run: mix compile
    env:
      MIX_ENV: test

  - key: db
    use: compile
    docker: preserve-data
    background-processes:
      - key: postgres
        run: |
          docker run -p '5432:5432' \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=splashlight_dev \
            postgres
        ready-check: pg_isready -U postgres -h localhost -p 5432
    run: |
      export PGUSER=postgres
      export PGPASSWORD=postgres
      export PGHOST=localhost
      mix ecto.create
      mix ecto.migrate
    env:
      MIX_ENV: test

  - key: test
    use: db
    docker: true
    background-processes:
      - key: postgres
        run: |
          docker run -p '5432:5432' \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=splashlight_dev \
            postgres
        ready-check: pg_isready -U postgres -h localhost -p 5432
    run: |
      export PGUSER=postgres
      export PGPASSWORD=postgres
      export PGHOST=localhost
      mix test
